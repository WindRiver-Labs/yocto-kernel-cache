From 45c82815ccf05b5dfadc41612353b9134fb911fa Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinh.nguyen@intel.com>
Date: Wed, 30 Sep 2020 11:53:02 -0500
Subject: [PATCH 133/151] HSD #14012623823: Address CVE error for Agilex clock
 driver

commit  f55f91c4d8260de2b5140b02ea762de67cf78815 from
https://github.com/altera-opensource/linux-socfpga.git
branch is socfpga-5.4.64-lts

Fix a Klokworks error scan on the Agilex clock driver.

The function call to of_clk_add_provider can return an error. If it does
return an error, return it to prevent a memory leak.

Signed-off-by: Dinh Nguyen <dinh.nguyen@intel.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
Integrated-by: Jun Zhang <jun.zhang@windriver.com>
---
 drivers/clk/socfpga/clk-agilex.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/clk/socfpga/clk-agilex.c b/drivers/clk/socfpga/clk-agilex.c
index 7f33dbc308ff..09cbecc682d7 100644
--- a/drivers/clk/socfpga/clk-agilex.c
+++ b/drivers/clk/socfpga/clk-agilex.c
@@ -1,6 +1,6 @@
 // SPDX-License-Identifier: GPL-2.0
 /*
- * Copyright (C) 2019, Intel Corporation
+ * Copyright (C) 2019-2020, Intel Corporation
  */
 #include <linux/slab.h>
 #include <linux/clk-provider.h>
@@ -264,6 +264,7 @@ static struct stratix10_clock_data *__socfpga_agilex_clk_init(struct platform_de
 	struct clk **clk_table;
 	struct resource *res;
 	void __iomem *base;
+	int ret;
 
 	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	base = devm_ioremap_resource(dev, res);
@@ -283,7 +284,10 @@ static struct stratix10_clock_data *__socfpga_agilex_clk_init(struct platform_de
 
 	clk_data->clk_data.clks = clk_table;
 	clk_data->clk_data.clk_num = nr_clks;
-	of_clk_add_provider(np, of_clk_src_onecell_get, &clk_data->clk_data);
+	ret = of_clk_add_provider(np, of_clk_src_onecell_get, &clk_data->clk_data);
+	if (ret)
+		return ERR_PTR(ret);
+
 	return clk_data;
 }
 
-- 
2.26.1

