From 779fa10be9672a5994906955110b5bb5922f5e01 Mon Sep 17 00:00:00 2001
From: Sudheesh Mavila <sudheesh.mavila@amd.com>
Date: Tue, 26 Nov 2019 17:11:15 +0530
Subject: [PATCH 2/4] amd-xgbe KR link up fix

Signed-off-by: Sudheesh Mavila <sudheesh.mavila@amd.com>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c b/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c
index ba37aecfa660..8c5be5a6338c 100755
--- a/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c
@@ -2572,12 +2572,14 @@ static int xgbe_phy_link_status(struct xgbe_prv_data *pdata, int *an_restart)
 	 */
 	reg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1);
 	reg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1);
-	if(phy_data->sfp_speed == XGBE_SFP_SPEED_10000) {
+	if((phy_data->sfp_speed == XGBE_SFP_SPEED_10000) ||(XGBE_MODE_KR == xgbe_phy_cur_mode(pdata))) {
 		if ((reg & MDIO_STAT1_LSTATUS) && !(reg & MDIO_STAT1_FAULT)) {
 			return 1;
 		} else {
+			mutex_lock(&pdata->an_mutex);
 			*an_restart = 1;
 			pdata->phy_if.phy_reset(pdata);
+			mutex_unlock(&pdata->an_mutex);
 			return 0;
 		}
 	} else {
-- 
2.17.1

