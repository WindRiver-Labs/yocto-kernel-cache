From 544c5438e1a9b68665548ef7106ae2b35141840b Mon Sep 17 00:00:00 2001
From: Yangbo Lu <yangbo.lu@nxp.com>
Date: Fri, 19 Jul 2019 10:53:35 +0800
Subject: [PATCH 618/741] ocelot: add get_ts_info interface for ethtool

commit c4bfe967c0b3001525f7c2c6ed88378bf5a2ce01 from
http://source.codeaurora.org/external/qoriq/qoriq-components/linux

Add get_ts_info interface for ethtool for showing
timestamping capability.

Signed-off-by: Yangbo Lu <yangbo.lu@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/net/ethernet/mscc/ocelot.c | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/drivers/net/ethernet/mscc/ocelot.c b/drivers/net/ethernet/mscc/ocelot.c
index dde819745520..cdc75093d4f9 100644
--- a/drivers/net/ethernet/mscc/ocelot.c
+++ b/drivers/net/ethernet/mscc/ocelot.c
@@ -1054,12 +1054,34 @@ static int ocelot_get_sset_count(struct net_device *dev, int sset)
 	return ocelot->num_stats;
 }
 
+static int ocelot_get_ts_info(struct net_device *dev,
+                              struct ethtool_ts_info *info)
+{
+        struct ocelot_port *port = netdev_priv(dev);
+        struct ocelot *ocelot = port->ocelot;
+ 
+        if (ocelot->clock)
+                info->phc_index = ocelot->phc_index;
+        else
+                info->phc_index = -1;
+
+        info->so_timestamping = SOF_TIMESTAMPING_TX_HARDWARE |
+                                SOF_TIMESTAMPING_RX_HARDWARE |
+                                SOF_TIMESTAMPING_RAW_HARDWARE;
+        info->tx_types = (1 << HWTSTAMP_TX_OFF) |
+                         (1 << HWTSTAMP_TX_ON);
+        info->rx_filters = (1 << HWTSTAMP_FILTER_NONE) |
+                           (1 << HWTSTAMP_FILTER_ALL);
+        return 0;
+}
+
 static const struct ethtool_ops ocelot_ethtool_ops = {
 	.get_strings		= ocelot_get_strings,
 	.get_ethtool_stats	= ocelot_get_ethtool_stats,
 	.get_sset_count		= ocelot_get_sset_count,
 	.get_link_ksettings	= phy_ethtool_get_link_ksettings,
 	.set_link_ksettings	= phy_ethtool_set_link_ksettings,
+	.get_ts_info            = ocelot_get_ts_info,
 };
 
 static int ocelot_port_attr_stp_state_set(struct ocelot_port *ocelot_port,
-- 
2.17.1

