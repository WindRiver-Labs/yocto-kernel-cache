From 2f334ae062ee753aa808cba11e557ed481d92c3e Mon Sep 17 00:00:00 2001
From: Razvan Stefanescu <razvan.stefanescu@nxp.com>
Date: Tue, 3 Apr 2018 13:53:00 +0300
Subject: [PATCH 135/741] staging: dpaa2-evb: Use MC portal in atomic context

commit e3e07b712288cb72c7bd88d20d70bb55d2b6fcd9 from
http://source.codeaurora.org/external/qoriq/qoriq-components/linux

Avoid triggering stack trace when retrieving interface counters via
ifconfig by allocating MC portal with atomic I/O enabled.

Signed-off-by: Razvan Stefanescu <razvan.stefanescu@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/staging/fsl-dpaa2/evb/evb.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/fsl-dpaa2/evb/evb.c b/drivers/staging/fsl-dpaa2/evb/evb.c
index 35f3272b8f01..ab9eeea2fc85 100644
--- a/drivers/staging/fsl-dpaa2/evb/evb.c
+++ b/drivers/staging/fsl-dpaa2/evb/evb.c
@@ -1204,7 +1204,8 @@ static int evb_probe(struct fsl_mc_device *evb_dev)
 
 	priv = netdev_priv(netdev);
 
-	err = fsl_mc_portal_allocate(evb_dev, 0, &priv->mc_io);
+	err = fsl_mc_portal_allocate(evb_dev, FSL_MC_IO_ATOMIC_CONTEXT_PORTAL,
+				     &priv->mc_io);
 	if (unlikely(err)) {
 		dev_err(dev, "fsl_mc_portal_allocate err %d\n", err);
 		goto err_free_netdev;
-- 
2.17.1

