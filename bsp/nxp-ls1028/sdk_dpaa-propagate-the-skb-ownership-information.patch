From 69b3c5812ac2a6b27ca62f134295fd798da9202c Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@nxp.com>
Date: Wed, 25 Apr 2018 18:49:32 +0300
Subject: [PATCH 200/741] sdk_dpaa: propagate the skb ownership information

commit 3129ff1b845895ddffd38eab4708cb55549d1865 from
http://source.codeaurora.org/external/qoriq/qoriq-components/linux

Some skbs on the Tx path may be reallocated by the driver
due to insufficient headroom, in which case the socket
value gets lost.

Make sure we propagate the skb ownership information to the
new skb, since it's needed by the Tx timestamp function in
the kernel.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@nxp.com>
Signed-off-by: Madalin Bucur <madalin.bucur@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_sg.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_sg.c b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_sg.c
index 138919aad93d..93ce26ffa6e7 100644
--- a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_sg.c
+++ b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_sg.c
@@ -1113,6 +1113,11 @@ int __hot dpa_tx_extended(struct sk_buff *skb, struct net_device *net_dev,
 				percpu_stats->tx_errors++;
 				return NETDEV_TX_OK;
 			}
+
+			/* propagate the skb ownership information */
+			if (skb->sk)
+				skb_set_owner_w(skb_new, skb->sk);
+
 			dev_kfree_skb(skb);
 			skb = skb_new;
 		}
-- 
2.17.1

