From c6d3ae35745e679e9221c0a82726cacce3fab912 Mon Sep 17 00:00:00 2001
From: Camelia Groza <camelia.groza@nxp.com>
Date: Mon, 26 Mar 2018 10:48:19 +0300
Subject: [PATCH 195/741] sdk_fman: probe OH ports on PPC

commit 12bb92b9c8634394c608beceb18cff84a4b72536 from
http://source.codeaurora.org/external/qoriq/qoriq-components/linux

Signed-off-by: Camelia Groza <camelia.groza@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 .../freescale/sdk_fman/src/wrapper/lnxwrp_fm_port.c  | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/sdk_fman/src/wrapper/lnxwrp_fm_port.c b/drivers/net/ethernet/freescale/sdk_fman/src/wrapper/lnxwrp_fm_port.c
index 7a1ec1fb7a53..3d61ff7346ed 100644
--- a/drivers/net/ethernet/freescale/sdk_fman/src/wrapper/lnxwrp_fm_port.c
+++ b/drivers/net/ethernet/freescale/sdk_fman/src/wrapper/lnxwrp_fm_port.c
@@ -303,7 +303,13 @@ static t_LnxWrpFmPortDev *ReadFmPortDevTreeNode(struct platform_device
 	tmp_prop = be32_to_cpu(*uint32_prop);
 	if (WARN_ON(lenp != sizeof(uint32_t)))
 		return NULL;
-	if (of_device_is_compatible(port_node, "fsl,fman-port-oh")) {
+	if (of_device_is_compatible(port_node, "fsl,fman-port-oh") ||
+	    of_device_is_compatible(port_node, "fsl,fman-v2-port-oh") ||
+	    of_device_is_compatible(port_node, "fsl,fman-v3-port-oh")) {
+#ifndef CONFIG_FMAN_ARM
+		/* On PPC, OH ports start from cell-index 0x2 */
+		tmp_prop -= 0x2;
+#endif
 		if (unlikely(tmp_prop >= FM_MAX_NUM_OF_OH_PORTS)) {
 			REPORT_ERROR(MAJOR, E_INVALID_VALUE,
 				     ("of_get_property(%s, cell-index) failed",
@@ -1432,6 +1438,10 @@ static int fm_port_remove(struct platform_device *of_dev)
 static const struct of_device_id fm_port_match[] = {
 	{
 	 .compatible = "fsl,fman-port-oh"},
+	{
+	 .compatible = "fsl,fman-v2-port-oh"},
+	{
+	 .compatible = "fsl,fman-v3-port-oh"},
 	{
 	 .compatible = "fsl,fman-port-1g-rx"},
 	{
-- 
2.17.1

