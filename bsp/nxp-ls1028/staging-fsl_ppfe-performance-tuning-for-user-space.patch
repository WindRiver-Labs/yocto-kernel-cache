From 93ffb0e28bc78cd6ca476174d8e94dc919bcb9d7 Mon Sep 17 00:00:00 2001
From: Akhil Goyal <akhil.goyal@nxp.com>
Date: Fri, 20 Jul 2018 16:43:25 +0530
Subject: [PATCH 343/741] staging: fsl_ppfe: performance tuning for user space

commit 1d8e8faa2ffb19e0ffa1a9183d023c8339e10a68 from
http://source.codeaurora.org/external/qoriq/qoriq-components/linux

interrupt coalescing of 100 usec is added.

Signed-off-by: Akhil Goyal <akhil.goyal@nxp.com>
Signed-off-by: Sachin Saxena <sachin.saxena@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/staging/fsl_ppfe/pfe_cdev.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/staging/fsl_ppfe/pfe_cdev.c b/drivers/staging/fsl_ppfe/pfe_cdev.c
index ddfc53c49087..c7d25a7219b9 100644
--- a/drivers/staging/fsl_ppfe/pfe_cdev.c
+++ b/drivers/staging/fsl_ppfe/pfe_cdev.c
@@ -116,15 +116,18 @@ static irqreturn_t hif_us_isr(int irq, void *arg)
 
 	if (int_status & HIF_RXPKT_INT) {
 		int_enable_mask &= ~(HIF_RXPKT_INT);
+		/* Disable interrupts, they will be enabled after
+		 * they are serviced
+		 */
+		writel_relaxed(int_enable_mask, HIF_INT_ENABLE);
+
 		eventfd_signal(trigger, 1);
 	}
 
-	/*Disable interrupts, they will be enabled after they are serviced */
-	writel_relaxed(int_enable_mask, HIF_INT_ENABLE);
-
 	return IRQ_HANDLED;
 }
 
+#define PFE_INTR_COAL_USECS	100
 static long pfe_cdev_ioctl(struct file *fp, unsigned int cmd,
 			   unsigned long arg)
 {
@@ -159,6 +162,9 @@ static long pfe_cdev_ioctl(struct file *fp, unsigned int cmd,
 			eventfd_ctx_put(g_trigger);
 			g_trigger = NULL;
 		}
+		writel((PFE_INTR_COAL_USECS * (pfe->ctrl.sys_clk / 1000)) |
+			HIF_INT_COAL_ENABLE, HIF_INT_COAL);
+
 		pr_debug("request_irq for hif interrupt: %d\n", pfe->hif_irq);
 		ret = 0;
 		break;
-- 
2.17.1

