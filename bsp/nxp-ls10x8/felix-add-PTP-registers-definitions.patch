From 87165bc3c26a41bb629dbe73b62698d251c29df6 Mon Sep 17 00:00:00 2001
From: Yangbo Lu <yangbo.lu@nxp.com>
Date: Wed, 17 Jul 2019 13:38:33 +0800
Subject: [PATCH 177/245] felix: add PTP registers definitions

commit 1c6fe5b16892b2e2101e375a3a73eaafb4c7a5c0 from
http://source.codeaurora.org/external/qoriq/qoriq-components/linux.git

Add PTP registers definitions for Felix.

Signed-off-by: Yangbo Lu <yangbo.lu@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/net/ethernet/mscc/felix_board.c |  7 +++
 drivers/net/ethernet/mscc/felix_regs.c  | 22 ++++++++++
 drivers/net/ethernet/mscc/ocelot.h      | 20 +++++++++
 drivers/net/ethernet/mscc/ocelot_ptp.h  | 57 +++++++++++++++++++++++++
 4 files changed, 106 insertions(+)
 create mode 100644 drivers/net/ethernet/mscc/ocelot_ptp.h

diff --git a/drivers/net/ethernet/mscc/felix_board.c b/drivers/net/ethernet/mscc/felix_board.c
index 39df7f000d94..7f37e07a87e1 100644
--- a/drivers/net/ethernet/mscc/felix_board.c
+++ b/drivers/net/ethernet/mscc/felix_board.c
@@ -45,6 +45,13 @@ static struct {
 			.name = "ana",
 		}
 	},
+	{	.id = PTP,
+		{
+			.start = 0x0090000,
+			.end = 0x00900cb,
+			.name = "ptp",
+		}
+	},
 	{	.id = QS,
 		{
 			.start = 0x0080000,
diff --git a/drivers/net/ethernet/mscc/felix_regs.c b/drivers/net/ethernet/mscc/felix_regs.c
index 33e545505b4e..adaae6789d3d 100644
--- a/drivers/net/ethernet/mscc/felix_regs.c
+++ b/drivers/net/ethernet/mscc/felix_regs.c
@@ -108,6 +108,27 @@ static const u32 felix_ana_regmap[] = {
 	REG_RESERVED(ANA_POL_MISC_CFG),
 };
 
+static const u32 felix_ptp_regmap[] = {
+	REG(PTP_MISC_CFG,                  0x0000a0),
+	REG(PTP_CLK_ADJ_CFG,               0x0000a4),
+	REG(PTP_CLK_ADJ_FRQ,               0x0000a8),
+	REG(PTP_PIN_INTR,                  0x0000ac),
+	REG(PTP_PIN_INTR_ENA,              0x0000b0),
+	REG(PTP_INTR_IDENT,                0x0000b4),
+	REG(PTP_SYS_CLK_CFG,               0x0000b8),
+	REG(PTP_CUR_NSF,                   0x0000bc),
+	REG(PTP_CUR_NSEC,                  0x0000c0),
+	REG(PTP_CUR_SEC_LSB,               0x0000c4),
+	REG(PTP_CUR_SEC_MSB,               0x0000c8),
+	REG(PTP_PIN_CFG,                   0x000000),
+	REG(PTP_TOD_SEC_MSB,               0x000004),
+	REG(PTP_TOD_SEC_LSB,               0x000008),
+	REG(PTP_TOD_NSEC,                  0x00000c),
+	REG(PTP_NSF,                       0x000010),
+	REG(PTP_PIN_WF_HIGH_PERIOD,        0x000014),
+	REG(PTP_PIN_WF_LOW_PERIOD,         0x000018),
+};
+
 static const u32 felix_qs_regmap[] = {
 	REG(QS_XTR_GRP_CFG,                0x000000),
 	REG(QS_XTR_RD,                     0x000008),
@@ -286,6 +307,7 @@ static const u32 felix_gcb_regmap[] = {
 
 static const u32 *felix_regmap[] = {
 	[ANA] = felix_ana_regmap,
+	[PTP] = felix_ptp_regmap,
 	[QS] = felix_qs_regmap,
 	[QSYS] = felix_qsys_regmap,
 	[REW] = felix_rew_regmap,
diff --git a/drivers/net/ethernet/mscc/ocelot.h b/drivers/net/ethernet/mscc/ocelot.h
index 92bafad168af..59a4076b859e 100644
--- a/drivers/net/ethernet/mscc/ocelot.h
+++ b/drivers/net/ethernet/mscc/ocelot.h
@@ -17,6 +17,7 @@
 #include "ocelot_ana.h"
 #include "ocelot_dev.h"
 #include "ocelot_hsio.h"
+#include "ocelot_ptp.h"
 #include "ocelot_qsys.h"
 #include "ocelot_rew.h"
 #include "ocelot_sys.h"
@@ -70,6 +71,7 @@ struct frame_info {
 
 enum ocelot_target {
 	ANA = 1,
+	PTP,
 	QS,
 	QSYS,
 	REW,
@@ -179,6 +181,24 @@ enum ocelot_reg {
 	ANA_POL_FLOWC,
 	ANA_POL_HYST,
 	ANA_POL_MISC_CFG,
+	PTP_MISC_CFG = PTP << TARGET_OFFSET,
+	PTP_CLK_ADJ_CFG,
+	PTP_CLK_ADJ_FRQ,
+	PTP_PIN_INTR,
+	PTP_PIN_INTR_ENA,
+	PTP_INTR_IDENT,
+	PTP_SYS_CLK_CFG,
+	PTP_CUR_NSF,
+	PTP_CUR_NSEC,
+	PTP_CUR_SEC_LSB,
+	PTP_CUR_SEC_MSB,
+	PTP_PIN_CFG,
+	PTP_TOD_SEC_MSB,
+	PTP_TOD_SEC_LSB,
+	PTP_TOD_NSEC,
+	PTP_NSF,
+	PTP_PIN_WF_HIGH_PERIOD,
+	PTP_PIN_WF_LOW_PERIOD,
 	QS_XTR_GRP_CFG = QS << TARGET_OFFSET,
 	QS_XTR_RD,
 	QS_XTR_FRM_PRUNING,
diff --git a/drivers/net/ethernet/mscc/ocelot_ptp.h b/drivers/net/ethernet/mscc/ocelot_ptp.h
new file mode 100644
index 000000000000..473f28da42c4
--- /dev/null
+++ b/drivers/net/ethernet/mscc/ocelot_ptp.h
@@ -0,0 +1,57 @@
+/* SPDX-License-Identifier: (GPL-2.0 OR MIT) */
+/* Microsemi Ocelot Switch driver
+ *
+ * Copyright (c) 2017 Microsemi Corporation
+ * Copyright 2018-2019 NXP
+ */
+
+#ifndef _MSCC_OCELOT_PTP_H_
+#define _MSCC_OCELOT_PTP_H_
+
+/* PTP_PINS register group */
+#define PTP_PIN_CFG_RSZ			0x20
+#define PTP_TOD_SEC_MSB_RSZ		PTP_PIN_CFG_RSZ
+#define PTP_TOD_SEC_LSB_RSZ		PTP_PIN_CFG_RSZ
+#define PTP_TOD_NSEC_RSZ		PTP_PIN_CFG_RSZ
+#define PTP_NSF_RSZ			PTP_PIN_CFG_RSZ
+#define PTP_PIN_WF_HIGH_PERIOD_RSZ	PTP_PIN_CFG_RSZ
+#define PTP_PIN_WF_LOW_PERIOD_RSZ	PTP_PIN_CFG_RSZ
+
+/* PTP_PIN_CFG register */
+#define PTP_PIN_CFG_DOM			BIT(0)
+#define PTP_PIN_CFG_SYNC		BIT(2)
+#define PTP_PIN_CFG_ACTION(x)		((x) << 3)
+#define PTP_PIN_CFG_ACTION_MASK		PTP_PIN_CFG_ACTION(0x7)
+
+enum {
+	PTP_PIN_ACTION_IDLE = 0,
+	PTP_PIN_ACTION_LOAD,
+	PTP_PIN_ACTION_SAVE,
+	PTP_PIN_ACTION_CLOCK,
+	PTP_PIN_ACTION_DELTA,
+};
+
+/* PTP_MISC_CFG register */
+#define PTP_MISC_CFG_PTP_ENA		BIT(2)
+
+/* PTP_CLK_ADJ_CFG register */
+#define PTP_CLK_ADJ_CFG_ENA		BIT(0)
+#define PTP_CLK_ADJ_CFG_DIR		BIT(1)
+
+/* PTP_CLK_ADJ_FRQ register */
+#define PTP_CLK_ADJ_FRQ_UNIT		BIT(30)
+
+/* PTP_SYS_CLK_CFG register
+ *
+ * Default system clock period 6.4ns (Frequency 156.25MHz)
+ */
+#define PTP_SYS_CLK_CFG_PER_NS_DEFAULT		0x6
+#define PTP_SYS_CLK_CFG_PER_NS_SHIFT		4
+#define PTP_SYS_CLK_CFG_PER_PS100_DEFAULT	0x4
+
+#define PSEC_PER_SEC			1000000000000LL
+
+#define NSEC_MASK			0x3fffffff
+#define SEC_MSB_MASK			0x0000ffff
+
+#endif
-- 
2.17.1

