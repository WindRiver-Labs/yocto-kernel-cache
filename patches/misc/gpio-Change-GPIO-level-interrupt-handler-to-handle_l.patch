From eb6a91a26dd903d074cf987bbe00df508775b3a9 Mon Sep 17 00:00:00 2001
From: Witold Sadowski <wsadowski@marvell.com>
Date: Thu, 16 Sep 2021 13:08:51 -0700
Subject: [PATCH 03/11] gpio: Change GPIO level interrupt handler to
 handle_level_irq
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit ce614ec4b82e759b18824d945c1f2f74b070626d from
git@git.assembla.com:cavium/WindRiver.linux.git

The current level interrupt handler configured is masking GPIO
interrupt and never unmasking it.
This is incorrect, as level IRQ will be handled only once.
Fix it with use of handle_level_irq, which will unmask interrupt and
thus allow the next interrupt to be handled.‚Äù

Signed-off-by: Witold Sadowski <wsadowski@marvell.com>
Change-Id: Ibff0f36597d158830f0fb3c182a378d98677ed65
Reviewed-on: https://sj1git1.cavium.com/c/IP/SW/kernel/linux/+/61297
Reviewed-by: Chandrakala Chavva <cchavva@marvell.com>
Tested-by: sa_ip-sw-jenkins <sa_ip-sw-jenkins@marvell.com>
(cherry picked from commit 6f5c1fd022d9304fa510626341f5502e0e6a73aa)
Reviewed-on: https://sj1git1.cavium.com/c/IP/SW/kernel/linux/+/61684
Integrated-by: Abhishek Paliwal <paliwal.abhishek@windriver.com>
---
 drivers/gpio/gpio-thunderx.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/gpio/gpio-thunderx.c b/drivers/gpio/gpio-thunderx.c
index 6187ea678828..1e58f1dcbe22 100644
--- a/drivers/gpio/gpio-thunderx.c
+++ b/drivers/gpio/gpio-thunderx.c
@@ -688,7 +688,7 @@ static int thunderx_gpio_irq_set_type(struct irq_data *data,
 		irq_set_handler_locked(data, handle_fasteoi_ack_irq);
 		bit_cfg |= GPIO_BIT_CFG_INT_TYPE;
 	} else {
-		irq_set_handler_locked(data, handle_fasteoi_mask_irq);
+		irq_set_handler_locked(data, handle_level_irq);
 	}
 
 	if (flow_type & (IRQ_TYPE_EDGE_FALLING | IRQ_TYPE_LEVEL_LOW)) {
-- 
2.31.1

