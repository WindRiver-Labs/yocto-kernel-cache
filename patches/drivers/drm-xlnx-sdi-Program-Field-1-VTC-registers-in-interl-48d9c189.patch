From fd448475c9dc720c1ce7ea5cf82868790a0fac3c Mon Sep 17 00:00:00 2001
From: Vishal Sagar <vishal.sagar@xilinx.com>
Date: Wed, 25 Jul 2018 15:55:19 +0530
Subject: [PATCH 0386/1851] drm: xlnx: sdi: Program Field 1 VTC registers in
 interlaced mode only

commit 905ba01e752a787258c7951a2cbbe86f63159866 from
https://github.com/Xilinx/linux-xlnx.git

The VTC has registers for field 0 and field 1. This patch allows
updating the field 1 registers only when in interlaced mode.

Signed-off-by: Vishal Sagar <vishal.sagar@xilinx.com>
Reviewed-by: Hyun Kwon <hyun.kwon@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
State: pending
Signed-off-by: Yaliang Wang <Yaliang.Wang@windriver.com>
---
 drivers/gpu/drm/xlnx/xlnx_sdi_timing.c | 26 ++++++++++++++++----------
 1 file changed, 16 insertions(+), 10 deletions(-)

diff --git a/drivers/gpu/drm/xlnx/xlnx_sdi_timing.c b/drivers/gpu/drm/xlnx/xlnx_sdi_timing.c
index b74b2d21c03f..9c9348c1ad9c 100644
--- a/drivers/gpu/drm/xlnx/xlnx_sdi_timing.c
+++ b/drivers/gpu/drm/xlnx/xlnx_sdi_timing.c
@@ -224,11 +224,13 @@ static void xlnx_stc_polarity(void __iomem *base,
  * xlnx_stc_hori_off - Configure horzontal timing offset
  * @base:	Base address of SDI Tx subsystem
  * @hori_off:	horizontal offset configuration data
+ * @flags:	Display flags
  *
  * This function configure horizontal offset
  */
 static void xlnx_stc_hori_off(void __iomem *base,
-			      struct xlnx_stc_hori_off *hori_off)
+			      struct xlnx_stc_hori_off *hori_off,
+			      enum display_flags flags)
 {
 	u32 reg;
 
@@ -245,16 +247,20 @@ static void xlnx_stc_hori_off(void __iomem *base,
 	xlnx_stc_writel(base, XSTC_GVSH_F0, reg);
 
 	/* Calculate and update Generator VBlank Hori field 1 */
-	reg = hori_off->v1blank_hori_start & XSTC_XVXHOX_HSTART_MASK;
-	reg |= (hori_off->v1blank_hori_end << XSTC_XVXHOX_HEND_SHIFT) &
-		XSTC_XVXHOX_HEND_MASK;
-	xlnx_stc_writel(base, XSTC_GVBH_F1, reg);
+	if (flags & DISPLAY_FLAGS_INTERLACED) {
+		reg = hori_off->v1blank_hori_start & XSTC_XVXHOX_HSTART_MASK;
+		reg |= (hori_off->v1blank_hori_end << XSTC_XVXHOX_HEND_SHIFT) &
+			XSTC_XVXHOX_HEND_MASK;
+		xlnx_stc_writel(base, XSTC_GVBH_F1, reg);
+	}
 
 	/* Calculate and update Generator VBlank Hori field 1 */
-	reg =  hori_off->v1sync_hori_start & XSTC_XVXHOX_HSTART_MASK;
-	reg |= (hori_off->v1sync_hori_end << XSTC_XVXHOX_HEND_SHIFT) &
-		XSTC_XVXHOX_HEND_MASK;
-	xlnx_stc_writel(base, XSTC_GVSH_F1, reg);
+	if (flags & DISPLAY_FLAGS_INTERLACED) {
+		reg = hori_off->v1sync_hori_start & XSTC_XVXHOX_HSTART_MASK;
+		reg |= (hori_off->v1sync_hori_end << XSTC_XVXHOX_HEND_SHIFT) &
+			XSTC_XVXHOX_HEND_MASK;
+		xlnx_stc_writel(base, XSTC_GVSH_F1, reg);
+	}
 }
 
 /**
@@ -397,7 +403,7 @@ void xlnx_stc_sig(void __iomem *base, struct videomode *vm)
 		xlnx_stc_writel(base, XSTC_GENC, reg);
 	}
 
-	xlnx_stc_hori_off(base, &hori_off);
+	xlnx_stc_hori_off(base, &hori_off, vm->flags);
 	/* set up polarity */
 	memset(&polarity, 0x0, sizeof(polarity));
 	polarity.hsync = !!(vm->flags & DISPLAY_FLAGS_HSYNC_LOW);
-- 
2.31.1

