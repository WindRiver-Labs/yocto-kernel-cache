From bf50a9a30fe55aae61c9bbbcd36196578a5a1b15 Mon Sep 17 00:00:00 2001
From: Vasyl Gomonovych <vgomonovych@marvell.com>
Date: Sat, 31 Jul 2021 02:35:18 -0700
Subject: [PATCH 1671/1921] drivers: marvell: otx2-sdei-ghes: Rename RAS driver

Change-Id: Iecf2cf69ae8f98361c7cd4b31cb95b9c6df8a54a
Signed-off-by: Vasyl Gomonovych <vgomonovych@marvell.com>
Reviewed-on: https://sj1git1.cavium.com/c/IP/SW/kernel/linux/+/57654
Reviewed-by: Chandrakala Chavva <cchavva@marvell.com>
Reviewed-by: Sunil Kovvuri Goutham <sgoutham@marvell.com>
Tested-by: Sunil Kovvuri Goutham <sgoutham@marvell.com>
[WK: The original patch got from Marvell sdk11.21.09]
Signed-off-by: Wenlin Kang <wenlin.kang@windriver.com>
---
 drivers/soc/marvell/Kconfig                   |  28 +--
 drivers/soc/marvell/Makefile                  |   2 +-
 drivers/soc/marvell/cn10k-ghes/Makefile       |  10 --
 drivers/soc/marvell/cn10k-ghes/mrvl-einj.c    | 170 ------------------
 drivers/soc/marvell/octeontx2-ghes/Makefile   |   8 +
 .../otx2-ghes-bert.c}                         |   4 +-
 .../otx2-ghes-bert.h}                         |   0
 .../otx2-sdei-ghes.c}                         |   2 +-
 .../otx2-sdei-ghes.h}                         |   0
 9 files changed, 20 insertions(+), 204 deletions(-)
 delete mode 100644 drivers/soc/marvell/cn10k-ghes/Makefile
 delete mode 100644 drivers/soc/marvell/cn10k-ghes/mrvl-einj.c
 create mode 100644 drivers/soc/marvell/octeontx2-ghes/Makefile
 rename drivers/soc/marvell/{cn10k-ghes/mrvl-ghes-bert.c => octeontx2-ghes/otx2-ghes-bert.c} (99%)
 rename drivers/soc/marvell/{cn10k-ghes/mrvl-ghes-bert.h => octeontx2-ghes/otx2-ghes-bert.h} (100%)
 rename drivers/soc/marvell/{cn10k-ghes/mrvl-sdei-ghes.c => octeontx2-ghes/otx2-sdei-ghes.c} (99%)
 rename drivers/soc/marvell/{cn10k-ghes/mrvl-sdei-ghes.h => octeontx2-ghes/otx2-sdei-ghes.h} (100%)

diff --git a/drivers/soc/marvell/Kconfig b/drivers/soc/marvell/Kconfig
index 7a3aa9bbd1df..f99a9875c01f 100644
--- a/drivers/soc/marvell/Kconfig
+++ b/drivers/soc/marvell/Kconfig
@@ -195,8 +195,8 @@ config MARVELL_CN10K_SWUP
 	    -> TIM Version check
 	    -> TIM Hash verification
 
-config MARVELL_SDEI_GHES
-	bool "Marvell Generic Hardware Error Source (GHES) support"
+config OCTEONTX2_SDEI_GHES
+	bool "OcteonTX2 Generic Hardware Error Source (GHES) support"
 	select ARM_SDE_INTERFACE
 	select ACPI_APEI
 	select ACPI_APEI_GHES
@@ -207,9 +207,9 @@ config MARVELL_SDEI_GHES
 	  This will allow RAS errors that are detected by the Marvell to
 	  be reported using kernel logging.
 
-config MARVELL_SDEI_GHES_DEBUG
-	bool "Marvell Generic Hardware Error Source (GHES) verbose debug msgs"
-	depends on MARVELL_SDEI_GHES
+config OCTEONTX2_SDEI_GHES_DEBUG
+	bool "OcteonTX2 Generic Hardware Error Source (GHES) verbose debug msgs"
+	depends on OCTEONTX2_SDEI_GHES
 	default n
 	help
 	  Say Y here if you want the Marvell GHES support to
@@ -218,9 +218,9 @@ config MARVELL_SDEI_GHES_DEBUG
 	  and want to see more details.
 	  If you are unsure about this, say N here.
 
-config MARVELL_GHES_BERT
-	bool "Marvell GHES Boot Error Record Table (BERT) support"
-	depends on MARVELL_SDEI_GHES
+config OCTEONTX2_GHES_BERT
+	bool "OcteonTX2 GHES Boot Error Record Table (BERT) support"
+	depends on OCTEONTX2_SDEI_GHES
 	default y
 	help
 	  Select this option to enable reporting of fatal Marvell GHES
@@ -228,16 +228,4 @@ config MARVELL_GHES_BERT
 	  reset the system.  Enabling support here will allow such errors
 	  to be reported when Linux is started again.
 
-config MARVELL_EINJ
-	tristate "Marvell EDAC ECC Injection"
-	depends on MARVELL_SDEI_GHES
-	help
-	  Provides support for error injection to MARVELL
-	  memory controllers (LMC) and cache blocks.
-	  This facilitates testing of the memory controller RAS features and
-	  is intended to be used by test personnel when conducting system tests.
-
-	  To compile this as a module, choose M here. The module will be
-	  called mrvl-einj.
-	  Unless testing, say N here.
 endmenu
diff --git a/drivers/soc/marvell/Makefile b/drivers/soc/marvell/Makefile
index 42576c9f806c..f8c98f5f8c04 100644
--- a/drivers/soc/marvell/Makefile
+++ b/drivers/soc/marvell/Makefile
@@ -14,4 +14,4 @@ obj-$(CONFIG_MRVL_PHY_DIAGNOSTICS) += phy_diag.o
 obj-$(CONFIG_MARVELL_CN10K_SERDES_DIAGNOSTICS) += cn10k_serdes_diag.o
 obj-$(CONFIG_MARVELL_CN10K_MAC_MGMT) += marvell_mac_mgmt.o
 obj-$(CONFIG_MARVELL_CN10K_RPRAM) += cn10k-rpram.o
-obj-$(CONFIG_MARVELL_SDEI_GHES) += cn10k-ghes/
+obj-$(CONFIG_OCTEONTX2_SDEI_GHES) += octeontx2-ghes/
diff --git a/drivers/soc/marvell/cn10k-ghes/Makefile b/drivers/soc/marvell/cn10k-ghes/Makefile
deleted file mode 100644
index fb44f533fd69..000000000000
--- a/drivers/soc/marvell/cn10k-ghes/Makefile
+++ /dev/null
@@ -1,10 +0,0 @@
-# SPDX-License-Identifier: GPL-2.0
-#
-# Makefile for Marvell's OcteonTX2 SDEI/GHES device driver
-#
-
-obj-$(CONFIG_MARVELL_SDEI_GHES) += mrvl_sdei_ghes.o
-mrvl_sdei_ghes-$(CONFIG_MARVELL_GHES_BERT) += mrvl-ghes-bert.o
-mrvl_sdei_ghes-y += mrvl-sdei-ghes.o
-
-obj-$(CONFIG_MARVELL_EINJ) += mrvl-einj.o
diff --git a/drivers/soc/marvell/cn10k-ghes/mrvl-einj.c b/drivers/soc/marvell/cn10k-ghes/mrvl-einj.c
deleted file mode 100644
index bcaf8acfe9d0..000000000000
--- a/drivers/soc/marvell/cn10k-ghes/mrvl-einj.c
+++ /dev/null
@@ -1,170 +0,0 @@
-/* SPDX-License-Identifier: GPL-2.0 */
-/*
- * OcteonTX2 memory controller ECC injection
- * Copyright Marvell Technologies. (C) 2019-2020. All rights reserved.
- */
-
-#include <linux/module.h>
-#include <linux/pci.h>
-
-#ifdef CONFIG_MARVELL_SDEI_GHES_DEBUG
-#  define dbgmsg(...) pr_info(__VA_ARGS__)
-#else
-#  define dbgmsg(...) (void)(__VA_ARGS__)
-#endif // CONFIG_OCTEONTX2_SDEI_GHES_DEBUG
-
-/*
- * All DRAM/cache controller hardware is handled by ATF on these platforms
- * and not visible to Non-Secure OS kernel.
- * The EDAC functions are passed to ATF by OCTEONTX_EDAC SMC, which performs
- * injection and reporting, and copies log stream back to kernel for reporting
- * detail in syslog.
- *
- * This is minimal SMC stub approach, minimally providing hooks for usermode
- * error-injection tools, to exercise either the legacy EDAC code of pre-4.18,
- * or the standard SDEI/GHES RAS handling possible in newer kernels.
- * It knows nothing of either, just asks ATF to corrupt memory.
- * This allows LMC/etc details to be hidden from EL2, all RAS/EDAC
- * work going to ATF/EL3 for security.
- *
- * For further details, see:
- *  ATF's docs/plat/marvell/marvell_ras.txt
- *  include/plat/marvell/octeontx/otx2/plat_ras.h
- */
-
-#define OCTEONTX_EDAC                   0xc2000c0b
-/* x1 is one of the following ... */
-#define OCTEONTX_EDAC_VER	0	/* report version */
-#define OCTEONTX_EDAC_INJECT	3	/* x2=addr x3=flags _F_xxx below */
-#define OCTEONTX_EDAC_MDC_CONST	4	/* read CAVM_MDC_CONST */
-#define OCTEONTX_EDAC_MDC_RW	5	/* read/write MDC */
-#define OCTEONTX_EDAC_MDC_ROM	6	/* read MDC_RAS_ROM x2=addr */
-
-#define OCTEONTX_EDAC_F_BITMASK	0x007 /* single bit to corrupt */
-#define OCTEONTX_EDAC_F_MULTI	0x008 /* corrupt multiple bits */
-#define OCTEONTX_EDAC_F_CLEVEL	0x070 /* cache level to corrupt (L0 == DRAM) */
-#define OCTEONTX_EDAC_F_ICACHE	0x080 /* Icache, not Dcache */
-#define OCTEONTX_EDAC_F_REREAD	0x100 /* read-back in EL3 */
-#define OCTEONTX_EDAC_F_PHYS	0x200 /* target is EL3-physical, not EL012 */
-
-#include <linux/arm-smccc.h>
-
-/*
- * Module parameters are used here instead of debugfs because debugfs requires
- * a kernel configuration option to be enabled, which potentially requires
- * a configuration change and kernel rebuild.
- * The use of error injection via this module is meant to be available at all
- * times (when the module is loaded) and should not require a special kernel.
- */
-static u64 smc_params[7];
-static u64 smc_result;
-static int smc_argc;
-
-/* an easily recognized value for logs */
-static const u64 test_val = 0x5555555555555555;
-
-/* target address for please-corrupt-EL1/EL2 I-cache/DRAM */
-static u64 ecc_test_target_fn(void)
-{
-	return test_val;
-}
-
-static int otx2_edac_smc(void)
-{
-	/* target address for please-corrupt-EL1/EL2 D-cache/DRAM: */
-	u64 ecc_test_target_data = test_val;
-	struct arm_smccc_res res;
-	bool test_read = false;
-	bool test_call = false;
-	u64 *a = smc_params;
-
-	/*
-	 * Replace magic ECC-injection addresses:
-	 * special ECC-injection addresses 0-3/4-7 are substituted by
-	 * EL0-3 code as instr/data targets at that execution level.
-	 * Any 0/4 addresses will have already been substituted
-	 * by EL0 test harness, here we substitute EL1/EL2 targets.
-	 * While 3/7 are replaced by ATF with its own test objects,
-	 * we remind it to reread in its own context.
-	 */
-	if (a[0] == OCTEONTX_EDAC_INJECT) {
-		a[2] &= ~OCTEONTX_EDAC_F_REREAD;
-		switch (a[1]) {
-		case 1 ... 2:	/* EL0..EL2 D-space target */
-			a[1] = (u64)&ecc_test_target_data;
-			test_read = true;
-			break;	/* EL0..EL2 I-space target */
-		case 5 ... 6:
-			a[1] = (u64)ecc_test_target_fn;
-			test_call = true;
-			break;
-		case 3: /* EL3 targets */
-		case 7:
-			a[2] |= OCTEONTX_EDAC_F_REREAD;
-			break;
-		}
-	}
-
-	arm_smccc_smc(OCTEONTX_EDAC, a[0], a[1], a[2], /* x1-x3 */
-		a[3], a[4], a[5], a[6], &res); /* x4-x7, result */
-	dbgmsg("%s: OCTEONTX_EDAC(%llx, %llx, %llx, %llx) -> e?%ld\n",
-		__func__, a[0], a[1], a[2], a[3], res.a0);
-
-	if (test_read && ecc_test_target_data != test_val)
-		dbgmsg("%s test_read mismatch\n", __func__);
-	if (test_call && ecc_test_target_fn() != test_val)
-		dbgmsg("%s test_call mismatch\n", __func__);
-
-	return res.a0;
-}
-
-static int smc_params_set(const char *_str, const struct kernel_param *kp)
-{
-	/* as with param_array_set(), temporarily overwrites string */
-	char *str = (char *)_str;
-	int rc;
-
-	trace_printk("%s: %s\n", __func__, str);
-
-	if (!str)
-		return -EINVAL;
-
-	smc_result = -EBUSY;
-
-	for (smc_argc = 0; smc_argc < 7 && *str; smc_argc++) {
-		int len = strcspn(str, ",");
-		char *nxt = len ? str + len + 1 : "";
-
-		if (len)
-			str[len] = '\0';
-		rc = kstrtoull(str, 0, &smc_params[smc_argc]);
-
-		dbgmsg("%s: (%s/%s) smc_params[%d]=%llx e?%d\n", __func__, str, nxt,
-				smc_argc, smc_params[smc_argc], rc);
-		if (len)
-			str[len] = ',';
-		str = nxt;
-		dbgmsg("%s: smc_params[%d]=%llx\n",
-			__func__, smc_argc, smc_params[smc_argc]);
-	}
-	smc_result = otx2_edac_smc();
-	dbgmsg("%s: result: %llx\n", __func__, smc_result);
-	return 0;
-}
-
-static int smc_params_get(char *buffer, const struct kernel_param *kp)
-{
-	return sprintf(buffer, "%lld\n", smc_result);
-}
-
-static const struct kernel_param_ops smc_params_ops = {
-	.set = smc_params_set,
-	.get = smc_params_get,
-};
-
-module_param_cb(smc_params, &smc_params_ops, smc_params, 0644);
-MODULE_PARM_DESC(smc_params, "call/return  values for OCTEONTX_EDAC SMC");
-
-MODULE_LICENSE("GPL v2");
-MODULE_AUTHOR("Marvell Semiconductor");
-MODULE_DESCRIPTION("OcteonTX2 ECC injector stub");
diff --git a/drivers/soc/marvell/octeontx2-ghes/Makefile b/drivers/soc/marvell/octeontx2-ghes/Makefile
new file mode 100644
index 000000000000..0a1cc314e972
--- /dev/null
+++ b/drivers/soc/marvell/octeontx2-ghes/Makefile
@@ -0,0 +1,8 @@
+# SPDX-License-Identifier: GPL-2.0
+#
+# Makefile for Marvell's OcteonTX2 SDEI/GHES device driver
+#
+
+obj-$(CONFIG_OCTEONTX2_SDEI_GHES) += otx2_sdei_ghes.o
+otx2_sdei_ghes-$(CONFIG_OCTEONTX2_GHES_BERT) += otx2-ghes-bert.o
+otx2_sdei_ghes-y += otx2-sdei-ghes.o
diff --git a/drivers/soc/marvell/cn10k-ghes/mrvl-ghes-bert.c b/drivers/soc/marvell/octeontx2-ghes/otx2-ghes-bert.c
similarity index 99%
rename from drivers/soc/marvell/cn10k-ghes/mrvl-ghes-bert.c
rename to drivers/soc/marvell/octeontx2-ghes/otx2-ghes-bert.c
index f778731f2c42..746d8a73833d 100644
--- a/drivers/soc/marvell/cn10k-ghes/mrvl-ghes-bert.c
+++ b/drivers/soc/marvell/octeontx2-ghes/otx2-ghes-bert.c
@@ -18,8 +18,8 @@
 #include <acpi/apei.h>
 #include <linux/pci.h>
 #include <linux/crash_dump.h>
-#include "mrvl-ghes-bert.h"
-#include "mrvl-sdei-ghes.h"
+#include "otx2-ghes-bert.h"
+#include "otx2-sdei-ghes.h"
 
 #define DRV_NAME	"bed-bert"
 
diff --git a/drivers/soc/marvell/cn10k-ghes/mrvl-ghes-bert.h b/drivers/soc/marvell/octeontx2-ghes/otx2-ghes-bert.h
similarity index 100%
rename from drivers/soc/marvell/cn10k-ghes/mrvl-ghes-bert.h
rename to drivers/soc/marvell/octeontx2-ghes/otx2-ghes-bert.h
diff --git a/drivers/soc/marvell/cn10k-ghes/mrvl-sdei-ghes.c b/drivers/soc/marvell/octeontx2-ghes/otx2-sdei-ghes.c
similarity index 99%
rename from drivers/soc/marvell/cn10k-ghes/mrvl-sdei-ghes.c
rename to drivers/soc/marvell/octeontx2-ghes/otx2-sdei-ghes.c
index 5cc8d8e38ac7..64ff90141f88 100644
--- a/drivers/soc/marvell/cn10k-ghes/mrvl-sdei-ghes.c
+++ b/drivers/soc/marvell/octeontx2-ghes/otx2-sdei-ghes.c
@@ -18,7 +18,7 @@
 #include <acpi/apei.h>
 #include <linux/pci.h>
 #include <linux/crash_dump.h>
-#include "mrvl-sdei-ghes.h"
+#include "otx2-sdei-ghes.h"
 
 #define DRV_NAME       "sdei-ghes"
 
diff --git a/drivers/soc/marvell/cn10k-ghes/mrvl-sdei-ghes.h b/drivers/soc/marvell/octeontx2-ghes/otx2-sdei-ghes.h
similarity index 100%
rename from drivers/soc/marvell/cn10k-ghes/mrvl-sdei-ghes.h
rename to drivers/soc/marvell/octeontx2-ghes/otx2-sdei-ghes.h
-- 
2.31.1

