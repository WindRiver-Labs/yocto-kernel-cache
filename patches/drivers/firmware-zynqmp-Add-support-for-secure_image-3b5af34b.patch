From a2fe18021a0e43f5c272a928b1a608b9fa72c0c9 Mon Sep 17 00:00:00 2001
From: Kalyani Akula <kalyani.akula@xilinx.com>
Date: Thu, 30 Jan 2020 14:59:08 +0530
Subject: [PATCH 1069/1851] firmware: zynqmp: Add support for secure_image

commit e5681672e31694b9a9dd720c1d3f2537175abc10 from
https://github.com/Xilinx/linux-xlnx.git

Secure image EEMI interface.

Signed-off-by: Kalyani Akula <kalyani.akula@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
State: pending
Signed-off-by: Yaliang Wang <Yaliang.Wang@windriver.com>
---
 drivers/firmware/xilinx/zynqmp.c     | 20 ++++++++++++++++++++
 include/linux/firmware/xlnx-zynqmp.h |  2 ++
 2 files changed, 22 insertions(+)

diff --git a/drivers/firmware/xilinx/zynqmp.c b/drivers/firmware/xilinx/zynqmp.c
index f7a2fc8e2deb..6e21b57a5181 100644
--- a/drivers/firmware/xilinx/zynqmp.c
+++ b/drivers/firmware/xilinx/zynqmp.c
@@ -1199,6 +1199,25 @@ static int zynqmp_pm_efuse_access(const u64 address, u32 *out)
 	return ret;
 }
 
+static int zynqmp_pm_secure_load(const u64 src_addr, u64 key_addr, u64 *dst)
+{
+	u32 ret_payload[PAYLOAD_ARG_CNT];
+	int ret_value;
+
+	if (!dst)
+		return -EINVAL;
+
+	ret_value = zynqmp_pm_invoke_fn(PM_SECURE_IMAGE,
+					lower_32_bits(src_addr),
+					upper_32_bits(src_addr),
+					lower_32_bits(key_addr),
+					upper_32_bits(key_addr),
+					ret_payload);
+	*dst = ((u64)ret_payload[1] << 32) | ret_payload[2];
+
+	return ret_value;
+}
+
 static const struct zynqmp_eemi_ops eemi_ops = {
 	.get_api_version = zynqmp_pm_get_api_version,
 	.get_chipid = zynqmp_pm_get_chipid,
@@ -1244,6 +1263,7 @@ static const struct zynqmp_eemi_ops eemi_ops = {
 	.aes = zynqmp_pm_aes_engine,
 	.efuse_access = zynqmp_pm_efuse_access,
 	.pdi_load = zynqmp_pm_load_pdi,
+	.secure_image = zynqmp_pm_secure_load,
 };
 
 /**
diff --git a/include/linux/firmware/xlnx-zynqmp.h b/include/linux/firmware/xlnx-zynqmp.h
index c0f7c270dc24..804c24d1fae1 100644
--- a/include/linux/firmware/xlnx-zynqmp.h
+++ b/include/linux/firmware/xlnx-zynqmp.h
@@ -129,6 +129,7 @@ enum pm_api_id {
 	PM_CLOCK_GETRATE,
 	PM_CLOCK_SETPARENT,
 	PM_CLOCK_GETPARENT,
+	PM_SECURE_IMAGE,
 	PM_FPGA_READ = 46,
 	PM_SECURE_AES,
 	/* PM_REGISTER_ACCESS API */
@@ -618,6 +619,7 @@ struct zynqmp_eemi_ops {
 			       u32 mask, u32 value, u32 *out);
 	int (*aes)(const u64 address, u32 *out);
 	int (*efuse_access)(const u64 address, u32 *out);
+	int (*secure_image)(const u64 src_addr, u64 key_addr, u64 *dst);
 	int (*pdi_load)(const u32 src, const u64 address);
 };
 
-- 
2.31.1

