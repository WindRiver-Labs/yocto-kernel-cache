From feac8366677486c604f2dee1432d7516e4d4c73b Mon Sep 17 00:00:00 2001
From: Suresh Gupta <suresh.gupta@xilinx.com>
Date: Fri, 8 Feb 2019 17:34:44 +0530
Subject: [PATCH 0506/1852] media: xilinx: multi-scaler: Align width to pixels
 per clock

commit 8368c5f19e8fd019d37c237159ab90ee54bf1390 from
https://github.com/Xilinx/linux-xlnx.git

The width value must be a multiple of pixels per clock

Signed-off-by: Suresh Gupta <suresh.gupta@xilinx.com>
Reviewed-by: Satish Kumar Nagireddy <satish.nagireddy.nagireddy@xilinx.com>
Reviewed-by: Vishal Sagar <vishal.sagar@xilinx.com>
Reviewed-by: Hyun Kwon <hyun.kwon@xilinx.com>
State: pending
Signed-off-by: Yaliang Wang <Yaliang.Wang@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-multi-scaler.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/drivers/media/platform/xilinx/xilinx-multi-scaler.c b/drivers/media/platform/xilinx/xilinx-multi-scaler.c
index 367f9ebef0b6..6c03661ae32c 100644
--- a/drivers/media/platform/xilinx/xilinx-multi-scaler.c
+++ b/drivers/media/platform/xilinx/xilinx-multi-scaler.c
@@ -1294,7 +1294,6 @@ xm2msc_cal_stride(unsigned int width, enum xm2msc_pix_fmt xfmt, u8 ppc)
 	u32 align;
 
 	/* Stride in Bytes = (Width Ã— Bytes per Pixel); */
-	/* TODO: The Width value must be a multiple of Pixels per Clock */
 	switch (xfmt) {
 	case XILINX_M2MSC_FMT_RGBX8:
 	case XILINX_M2MSC_FMT_YUVX8:
@@ -1348,6 +1347,15 @@ vidioc_try_fmt(struct xm2msc_chan_ctx *chan_ctx, struct v4l2_format *f)
 		dev_dbg(xm2msc->dev,
 			"Wrong input parameters %d, wxh: %dx%d.\n",
 			f->type, f->fmt.pix.width, f->fmt.pix.height);
+
+	/* The width value must be a multiple of pixels per clock */
+	if (pix->width % chan_ctx->xm2msc_dev->ppc) {
+		dev_info(xm2msc->dev,
+			 "Wrong align parameters %d, wxh: %dx%d.\n",
+			 f->type, f->fmt.pix.width, f->fmt.pix.height);
+		pix->width = ALIGN(pix->width, chan_ctx->xm2msc_dev->ppc);
+	}
+
 	/*
 	 * V4L2 specification suggests the driver corrects the
 	 * format struct if any of the dimensions is unsupported
-- 
2.31.1

