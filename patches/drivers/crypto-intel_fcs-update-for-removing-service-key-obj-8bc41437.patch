From 7ed64eb6f0ce41a1c321f758658484f3254abef6 Mon Sep 17 00:00:00 2001
From: Richard Gong <richard.gong@intel.com>
Date: Tue, 22 Jun 2021 11:40:19 -0500
Subject: [PATCH 08/42] crypto: intel_fcs: update for removing service key
 object

commit ae4e57bdf9873eff6a78ba97065c7d150b2bcf44 from
https://github.com/altera-opensource/linux-socfpga/commits/socfpga-5.4.124-lts

Update to support removing service key object.

Signed-off-by: Richard Gong <richard.gong@intel.com>
Integrated-by: Abhishek Paliwal <paliwal.abhishek@windriver.com>
---
 drivers/crypto/intel_fcs.c           | 26 ++++++++++++++++++++++++++
 include/uapi/linux/intel_fcs-ioctl.h |  5 +++++
 2 files changed, 31 insertions(+)

diff --git a/drivers/crypto/intel_fcs.c b/drivers/crypto/intel_fcs.c
index dbef379d4458..ee13ec17aeb0 100644
--- a/drivers/crypto/intel_fcs.c
+++ b/drivers/crypto/intel_fcs.c
@@ -1253,6 +1253,32 @@ static long fcs_ioctl(struct file *file, unsigned int cmd,
 		 fcs_close_services(priv, NULL, d_buf);
 		 break;
 
+	case INTEL_FCS_DEV_CRYPTO_REMOVE_KEY:
+		 if (copy_from_user(data, (void __user *)arg, sizeof(*data))) {
+			 dev_err(dev, "failure on copy_from_user\n");
+			 return -EFAULT;
+		 }
+
+		 msg->command = COMMAND_FCS_CRYPTO_REMOVE_KEY;
+		 msg->arg[0] = data->com_paras.k_object.sid;
+		 msg->arg[1] = data->com_paras.k_object.kid;
+		 priv->client.receive_cb = fcs_vab_callback;
+		 ret = fcs_request_service(priv, (void *)msg,
+					   FCS_REQUEST_TIMEOUT);
+		 if (ret) {
+			 dev_err(dev, "failed to send the request,ret=%d\n",
+				 ret);
+			 return -EFAULT;
+		 }
+
+		 data->status = priv->status;
+		 if (copy_to_user((void __user *)arg, data, sizeof(*data))) {
+			 dev_err(dev, "failure on copy_to_user\n");
+			 ret = -EFAULT;
+		 }
+
+		 break;
+
 	default:
 		dev_warn(dev, "shouldn't be here [0x%x]\n", cmd);
 		break;
diff --git a/include/uapi/linux/intel_fcs-ioctl.h b/include/uapi/linux/intel_fcs-ioctl.h
index 44e72c4d0e72..963dda198b9a 100644
--- a/include/uapi/linux/intel_fcs-ioctl.h
+++ b/include/uapi/linux/intel_fcs-ioctl.h
@@ -330,6 +330,7 @@ enum intel_fcs_command_code {
 	INTEL_FCS_DEV_CRYPTO_CLOSE_SESSION_CMD,
 	INTEL_FCS_DEV_CRYPTO_IMPORT_KEY_CMD,
 	INTEL_FCS_DEV_CRYPTO_EXPORT_KEY_CMD,
+	INTEL_FCS_DEV_CRYPTO_REMOVE_KEY_CMD,
 };
 
 #define INTEL_FCS_DEV_VERSION_REQUEST \
@@ -408,5 +409,9 @@ enum intel_fcs_command_code {
 	_IOWR(INTEL_FCS_IOCTL, \
 	      INTEL_FCS_DEV_CRYPTO_EXPORT_KEY_CMD, struct intel_fcs_dev_ioctl)
 
+#define INTEL_FCS_DEV_CRYPTO_REMOVE_KEY \
+	_IOWR(INTEL_FCS_IOCTL, \
+	      INTEL_FCS_DEV_CRYPTO_REMOVE_KEY_CMD, struct intel_fcs_dev_ioctl)
+
 #endif
 
-- 
2.31.1

