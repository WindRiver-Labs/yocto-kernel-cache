From 1c8afd5d90b707aaf56cc4fd7fc10d313b92b37b Mon Sep 17 00:00:00 2001
From: Subbaraya Sundeep <sbhatta@marvell.com>
Date: Thu, 6 Jun 2019 12:27:19 +0530
Subject: [PATCH 199/767] octeontx2-pf: Cleanup properly during driver remove

commit fdb7543bc0cdec7b680ab82ba7e017c4a64eff35 from
git@git.assembla.com:cavium/WindRiver.linux.git

When unbinding a PF driver sriov needs to be disabled
before disabling PF interrupts. Otherwise all the VF cleanup
messages never get response from AF since PF interrupt is
disabled. Also VF ntuple filters installed by a PF needs to
be deleted before VF removal otherwise already running
traffic may hit VF ntuple filter rules for removed VFs.

Change-Id: I1e7cefde646dc88ef5b14387e00a709b7f2d8876
Signed-off-by: Subbaraya Sundeep <sbhatta@marvell.com>
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/marvell/octeontx2/nic/otx2_pf.c | 11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/marvell/octeontx2/nic/otx2_pf.c b/drivers/net/ethernet/marvell/octeontx2/nic/otx2_pf.c
index 015c3d6cc872..026b90e9f755 100644
--- a/drivers/net/ethernet/marvell/octeontx2/nic/otx2_pf.c
+++ b/drivers/net/ethernet/marvell/octeontx2/nic/otx2_pf.c
@@ -2410,6 +2410,7 @@ static int otx2_sriov_disable(struct pci_dev *pdev)
 	if (!pci_num_vf(pdev))
 		return 0;
 
+	otx2_delete_vf_ethtool_flows(pf);
 	pci_disable_sriov(pdev);
 
 	for (i = 0; i < pci_num_vf(pdev); i++)
@@ -2418,7 +2419,6 @@ static int otx2_sriov_disable(struct pci_dev *pdev)
 
 	otx2_disable_flr_me_intr(pf);
 	otx2_flr_wq_destroy(pf);
-	otx2_delete_vf_ethtool_flows(pf);
 	otx2_disable_pfvf_mbox_intr(pf);
 	otx2_pfvf_mbox_destroy(pf);
 
@@ -2452,15 +2452,14 @@ static void otx2_remove(struct pci_dev *pdev)
 	otx2_cgx_config_linkevents(pf, false);
 
 	unregister_netdev(netdev);
-	otx2_destroy_ethtool_flows(pf);
-	otx2_ptp_destroy(pf);
 
-	otx2_disable_mbox_intr(pf);
+	otx2_sriov_disable(pf->pdev);
+	otx2_ptp_destroy(pf);
+	otx2_destroy_ethtool_flows(pf);
 
 	otx2_detach_resources(&pf->mbox);
+	otx2_disable_mbox_intr(pf);
 	otx2_pfaf_mbox_destroy(pf);
-	otx2_sriov_disable(pf->pdev);
-
 	pci_free_irq_vectors(pf->pdev);
 	pci_set_drvdata(pdev, NULL);
 	free_netdev(netdev);
-- 
2.31.1

