From 62873c7b28cd837d3ac805eba8f728903ab49ef6 Mon Sep 17 00:00:00 2001
From: Yuval Caduri <cyuval@marvell.com>
Date: Wed, 6 Apr 2016 02:33:43 +0300
Subject: [PATCH 0147/1345] fix: mvpp2x: allow full tx_queue_size allocation.

commit  234af68029ee5f03a5b9a9cf87707666585234f5 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Change-Id: Ib4a146c9d55b6a7b93f1b622a464e8bf7a639743
Signed-off-by: Yuval Caduri <cyuval@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/28809
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Tested-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |   32 ++++++++++++--------
 1 file changed, 19 insertions(+), 13 deletions(-)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 7493be2..28723a2 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -720,22 +720,28 @@ int mv_pp2x_txq_reserved_desc_num_proc(
 	 * count and check again.
 	 */
 
-	desc_count = 0;
-	/* Compute total of used descriptors */
-	for_each_online_cpu(cpu) {
-		struct mv_pp2x_txq_pcpu *txq_pcpu_aux;
+	/* Entire txq_size is used for SWF . Must be changed when HWF is implemented.
+	 * There will always be at least one CHUNK available
+	 */
 
-		txq_pcpu_aux = per_cpu_ptr(txq->pcpu, cpu);
-		desc_count += txq_pcpu_aux->count;
-		desc_count += txq_pcpu_aux->reserved_num;
-	}
+	req = MVPP2_CPU_DESC_CHUNK;
 
-	req = max(MVPP2_CPU_DESC_CHUNK, num - txq_pcpu->reserved_num);
-	desc_count += req;
+	if ((num - txq_pcpu->reserved_num) > req) {
+		req = num - txq_pcpu->reserved_num;
+		desc_count = 0;
+		/* Compute total of used descriptors */
+		for_each_online_cpu(cpu) {
+			struct mv_pp2x_txq_pcpu *txq_pcpu_aux;
 
-	if (desc_count >
-	   (txq->size - (num_active_cpus() * MVPP2_CPU_DESC_CHUNK)))
-		return -ENOMEM;
+			txq_pcpu_aux = per_cpu_ptr(txq->pcpu, cpu);
+			desc_count += txq_pcpu_aux->count;
+			desc_count += txq_pcpu_aux->reserved_num;
+		}
+		desc_count += req;
+
+		if (desc_count > txq->size)
+			return -ENOMEM;
+	}
 
 	txq_pcpu->reserved_num += mv_pp2x_txq_alloc_reserved_desc(priv, txq,
 								  req);
-- 
1.7.9.5

